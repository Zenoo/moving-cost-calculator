class MovingCostCalculator{constructor(target,parameters){if(this._elements={wrapper:null,departure:{address:null,optionToggler:null,options:{floor:null,lift:null,porterageDistance:null}},arrival:{address:null,optionToggler:null,options:{floor:null,lift:null,porterageDistance:null}},volume:null,contact:null,validation:{addresses:null,contact:null}},this._elements.wrapper=target instanceof Element?target:document.querySelector(target),!this._elements.wrapper)throw new Error("MovingCostCalculator: "+("string"==typeof target?"The selector `"+target+"` didn't match any element.":"The element you provided was undefined"));if(this._elements.wrapper.classList.contains("mcc-wrapper"))throw new Error("MovingCostCalculator: The element has already been initialized.");this._parameters={lang:"en",debug:!1,askForContact:!0,...parameters,options:{floor:!0,lift:!0,porterageDistance:!0,...parameters.options}},this.data={addresses:{departure:{value:"",components:{streetNumber:"",route:"",zipCode:"",locality:"",country:"",countryCode:"",department:"",region:""},location:{lat:0,lng:0,placeId:""},options:{floor:0,lift:!1,porterageDistance:0}},arrival:{value:"",components:{streetNumber:"",route:"",zipCode:"",locality:"",country:"",countryCode:"",department:"",region:""},location:{lat:0,lng:0,placeId:""},options:{floor:0,lift:!1,porterageDistance:0}}},volume:0,volumeData:{},contact:""},this._loadDictionary(),this._loadDependencies().then(()=>{this._parameters.debug&&console.log("MovingCostCalculator: DEPENDENCIES LOADED !"),this._build(),this._listen()})}_loadDependencies(){this._parameters.debug&&console.log("MovingCostCalculator: LOADING DEPENDENCIES ...");const movingVolumeCalculatorDependency=new Promise(solve=>{if("function"==typeof MovingVolumeCalculator)solve();else{const movingVolumeCalculatorScript=new Promise(resolve=>{this._loadResource("script","https://gitcdn.link/repo/Zenoo/moving-volume-calculator/master/MovingVolumeCalculator.min.js",()=>{this._parameters.debug&&console.log("DEPENDENCIES: MovingVolumeCalculator script LOADED !"),resolve()})}),movingVolumeCalculatorStyle=new Promise(resolve=>{this._loadResource("style","https://gitcdn.link/repo/Zenoo/moving-volume-calculator/master/MovingVolumeCalculator.min.css",()=>{this._parameters.debug&&console.log("DEPENDENCIES: MovingVolumeCalculator style LOADED !"),resolve()})});Promise.all([movingVolumeCalculatorScript,movingVolumeCalculatorStyle]).then(()=>{solve()})}}),googleMapsAPIDependency=new Promise(solve=>{if(window.google&&window.google.maps)solve();else{const gMapScripts=document.querySelectorAll('script[src^="https://maps.googleapis.com"]');gMapScripts.length&&(gMapScripts.forEach(gMapScript=>{gMapScript.remove()}),google&&Reflect.deleteProperty(google,"maps"));const newAPI=document.createElement("script");if(!this._parameters.googleAPIKey)throw new Error("MovingCostCalculator: You didn't provide your Google Maps API key. Please either pass it via the options' googleAPIKey attribute OR import the Google Maps API script on your own.");newAPI.src="https://maps.googleapis.com/maps/api/js?libraries=places&key="+this._parameters.googleAPIKey+"&language="+this._parameters.lang+"&callback=__mccGmapApiLoader",window.__mccGmapApiLoader=(()=>{this._parameters.debug&&console.log("DEPENDENCIES: Google Maps API script LOADED !"),solve()}),document.querySelector("head").appendChild(newAPI)}}),addressSearchDependency=new Promise(solve=>{if("function"==typeof AddressSearch)solve();else{const addressSearchScript=new Promise(resolve=>{this._loadResource("script","https://gitcdn.link/repo/Zenoo/address-search/master/address-search.min.js",()=>{this._parameters.debug&&console.log("DEPENDENCIES: AddressSearch script LOADED !"),resolve()})}),addressSearchStyle=new Promise(resolve=>{this._loadResource("style","https://gitcdn.link/repo/Zenoo/address-search/master/address-search.min.css",()=>{this._parameters.debug&&console.log("DEPENDENCIES: AddressSearch style LOADED !"),resolve()})});Promise.all([addressSearchScript,addressSearchStyle]).then(()=>{solve()})}}),ajaxSenderDependency=new Promise(solve=>{if("function"==typeof AjaxSender)solve();else{const ajaxSenderScript=new Promise(resolve=>{this._loadResource("script","https://gitcdn.link/repo/Zenoo/ajax-sender/1d834e01a9ffa3965d4a6adb2eade9f3d084e517/AjaxSender.min.js",()=>{this._parameters.debug&&console.log("DEPENDENCIES: AjaxSender script LOADED !"),resolve()})});ajaxSenderScript.then(()=>{solve()})}});return Promise.all([movingVolumeCalculatorDependency,googleMapsAPIDependency,addressSearchDependency,ajaxSenderDependency])}_loadResource(type,url,callback){const[head]=document.getElementsByTagName("head");if("script"==type){const script=document.createElement("script");script.src=url,script.onload=callback,head.appendChild(script)}else{const link=document.createElement("link");link.href=url,link.rel="stylesheet",link.type="text/css",link.onload=callback,head.appendChild(link)}}_loadDictionary(){this._dictionary={en:{title:"Estimate your moving cost",addressesTitle:"Your addresses",volumeTitle:"Your volume",estimationsTitle:"Estimations",departureAddress:"Departure address",arrivalAddress:"Arrival address",moreAddressOptions:"More options",lessAddressOptions:"Less options",floor:"Floor",lift:"Lift",porterageDistance:"Porterage Distance",yes:"Yes",no:"No",enterContact:"Please enter your mail to access your estimations",loading:"Loading ...",next:"Next"},fr:{title:"Estimez le coût de votre déménagement",addressesTitle:"Vos addresses",volumeTitle:"Votre volume",estimationsTitle:"Estimations",departureAddress:"Adresse de départ",arrivalAddress:"Adresse d'arrivée",moreAddressOptions:"Plus d'options",lessAddressOptions:"Moins d'options",floor:"Etage",lift:"Ascenseur",porterageDistance:"Distance de portage",yes:"Oui",no:"Non",enterContact:"Veuillez renseigner votre adresse mail pour accéder à vos estimations",loading:"Chargement ...",next:"Suivant"}},this._dictionary=Object.assign(this._dictionary,this._parameters.dictionary||{})}_build(){this._elements.wrapper.classList.add("mcc-wrapper");const title=document.createElement("h3");title.innerHTML=this._translated().title,this._elements.wrapper.appendChild(title),this._buildAddresses(),this._buildVolume(),this._parameters.askForContact&&this._buildContact(),this._buildLoader(),this._buildEstimations()}_buildAddresses(){let title=document.createElement("h4"),section=document.createElement("section"),p=document.createElement("p"),input=document.createElement("input"),div=document.createElement("div");(section=document.createElement("section")).classList.add("mcc-addresses"),this._elements.wrapper.appendChild(section),(title=document.createElement("h4")).innerHTML=this._translated().addressesTitle,section.appendChild(title),p.innerText=this._translated().departureAddress,section.appendChild(p),section.appendChild(input),this._elements.departure.address=new AddressSearch(input),Object.values(this._parameters.options).some(option=>1==option)&&((p=document.createElement("p")).classList.add("mcc-address-options-toggler"),section.appendChild(p),this._elements.departure.optionToggler=document.createElement("a"),this._elements.departure.optionToggler.classList.add("mcc-address-options-enable"),this._elements.departure.optionToggler.innerText=this._translated().moreAddressOptions,this._elements.departure.optionToggler.href="",p.appendChild(this._elements.departure.optionToggler),div.classList.add("mcc-address-options","mcc-departure","mcc-hidden"),section.appendChild(div),this._buildAddressOptions(this._elements.departure.options,div)),(p=document.createElement("p")).innerText=this._translated().arrivalAddress,section.appendChild(p),input=document.createElement("input"),section.appendChild(input),this._elements.arrival.address=new AddressSearch(input),Object.values(this._parameters.options).some(option=>1==option)&&((p=document.createElement("p")).classList.add("mcc-address-options-toggler"),section.appendChild(p),this._elements.arrival.optionToggler=document.createElement("a"),this._elements.arrival.optionToggler.classList.add("mcc-address-options-enable"),this._elements.arrival.optionToggler.innerText=this._translated().moreAddressOptions,this._elements.arrival.optionToggler.href="",p.appendChild(this._elements.arrival.optionToggler),(div=document.createElement("div")).classList.add("mcc-address-options","mcc-arrival","mcc-hidden"),section.appendChild(div),this._buildAddressOptions(this._elements.arrival.options,div)),p=document.createElement("p"),this._elements.validation.addresses=document.createElement("button"),this._elements.validation.addresses.disabled=!0,this._elements.validation.addresses.innerHTML=this._translated().next,p.appendChild(this._elements.validation.addresses),section.appendChild(p)}_buildAddressOptions(options,holder){Object.keys(options).forEach(option=>{if(this._parameters.options[option]){const p=document.createElement("p"),span=document.createElement("span");if(["lift"].includes(option)){options[option]=document.createElement("select");let optionTag=document.createElement("option");optionTag.value="false",optionTag.innerText=this._translated().no,options[option].appendChild(optionTag),(optionTag=document.createElement("option")).value="true",optionTag.innerText=this._translated().yes,options[option].appendChild(optionTag)}else options[option]=document.createElement("input");span.innerText=this._translated()[option],p.appendChild(span),p.appendChild(options[option]),holder.appendChild(p)}})}_buildVolume(){const title=document.createElement("h4"),section=document.createElement("section"),div=document.createElement("div");section.classList.add("mcc-volume","mcc-hidden"),this._elements.wrapper.appendChild(section),title.innerHTML=this._translated().volumeTitle,section.appendChild(title),section.appendChild(div),this._elements.volume=new MovingVolumeCalculator(div,{lang:this._parameters.lang,rooms:this._parameters.options.rooms})}_buildContact(){if(this._parameters.askForContact){const title=document.createElement("h4"),section=document.createElement("section"),p=document.createElement("p");section.classList.add("mcc-contact","mcc-hidden"),this._elements.wrapper.appendChild(section),title.innerHTML=this._translated().enterContact,section.appendChild(title),this._elements.contact=document.createElement("input"),section.appendChild(this._elements.contact),this._elements.validation.contact=document.createElement("button"),this._elements.validation.contact.disabled=!0,this._elements.validation.contact.innerHTML=this._translated().next,p.appendChild(this._elements.validation.contact),section.appendChild(p)}}_buildLoader(){const section=document.createElement("section"),p=document.createElement("p");section.classList.add("mcc-loader","mcc-hidden"),this._elements.wrapper.appendChild(section),p.innerHTML=this._translated().loading,section.appendChild(p)}_buildEstimations(){let title=document.createElement("title"),section=document.createElement("section");(section=document.createElement("section")).classList.add("mcc-estimations","mcc-hidden"),this._elements.wrapper.appendChild(section),(title=document.createElement("h4")).innerHTML=this._translated().estimationsTitle,section.appendChild(title)}_listen(){this._createDepartureAddressListeners(),this._createArrivalAddressListeners(),this._elements.validation.addresses.addEventListener("click",()=>{this._elements.wrapper.querySelector("section.mcc-volume").classList.remove("mcc-hidden"),this._elements.wrapper.querySelector("section.mcc-addresses").classList.add("mcc-hidden")}),this._elements.volume.onChange(value=>{this._elements.volume.isValid()&&(this.data.volume=value,this.data.volumeData=this._elements.volume.data)}).onValidate(data=>{this.data.volume=this._elements.volume.volume,this.data.volumeData=data,this._parameters.askForContact?(this._elements.wrapper.querySelector("section.mcc-contact").classList.remove("mcc-hidden"),this._elements.wrapper.querySelector("section.mcc-volume").classList.add("mcc-hidden")):(this._elements.wrapper.querySelector("section.mcc-loader").classList.remove("mcc-hidden"),this._elements.wrapper.querySelector("section.mcc-volume").classList.add("mcc-hidden"),this.validate())}),this._parameters.askForContact&&(this._elements.contact.addEventListener("input",()=>{const emailValidator=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;emailValidator.test(this._elements.contact.value)?(this.data.contact=this._elements.contact.value,this._elements.validation.contact.disabled=!1):this._elements.validation.contact.disabled=!0}),this._elements.validation.contact.addEventListener("click",()=>{this._elements.wrapper.querySelector("section.mcc-loader").classList.remove("mcc-hidden"),this._elements.wrapper.querySelector("section.mcc-contact").classList.add("mcc-hidden"),this.validate()}))}_createDepartureAddressListeners(){this._elements.departure.address.onSelect(address=>{this.data.addresses.departure.value=address.formatted_address,this.data.addresses.departure.components.streetNumber=this._getAddressComponent(address,"street_number"),this.data.addresses.departure.components.route=this._getAddressComponent(address,"route"),this.data.addresses.departure.components.zipCode=this._getAddressComponent(address,"postal_code"),this.data.addresses.departure.components.locality=this._getAddressComponent(address,"locality"),this.data.addresses.departure.components.country=this._getAddressComponent(address,"country"),this.data.addresses.departure.components.countryCode=this._getAddressComponent(address,"country",!0),this.data.addresses.departure.components.department=this._getAddressComponent(address,"administrative_area_level_2"),this.data.addresses.departure.components.region=this._getAddressComponent(address,"administrative_area_level_1"),this.data.addresses.departure.location.lat=address.geometry.location.lat(),this.data.addresses.departure.location.lng=address.geometry.location.lng(),this.data.addresses.departure.location.placeId=address.place_id,this._elements.departure.address.value.formatted_address&&this._elements.arrival.address.value.formatted_address?this._elements.validation.addresses.disabled=!1:this._elements.validation.addresses.disabled=!0}),Object.values(this._parameters.options).some(option=>1==option)&&(this._elements.departure.optionToggler.addEventListener("click",e=>{e.preventDefault(),this._elements.departure.optionToggler.classList.contains("mcc-address-options-enable")?(this._elements.departure.optionToggler.classList.remove("mcc-address-options-enable"),this._elements.departure.optionToggler.classList.add("mcc-address-options-disable"),this._elements.departure.optionToggler.innerText=this._translated().lessAddressOptions,this._elements.wrapper.querySelector(".mcc-departure.mcc-address-options").classList.remove("mcc-hidden")):(this._elements.departure.optionToggler.classList.remove("mcc-address-options-disable"),this._elements.departure.optionToggler.classList.add("mcc-address-options-enable"),this._elements.departure.optionToggler.innerText=this._translated().moreAddressOptions,this._elements.wrapper.querySelector(".mcc-departure.mcc-address-options").classList.add("mcc-hidden"))}),this._parameters.options.floor&&this._elements.departure.options.floor.addEventListener("change",()=>{this.data.addresses.departure.options.floor=+this._elements.departure.options.floor.value}),this._parameters.options.lift&&this._elements.departure.options.lift.addEventListener("change",()=>{this.data.addresses.departure.options.lift="true"==this._elements.departure.options.lift.value}),this._parameters.options.porterageDistance&&this._elements.departure.options.porterageDistance.addEventListener("change",()=>{this.data.addresses.departure.options.porterageDistance=+this._elements.departure.options.porterageDistance.value}))}_createArrivalAddressListeners(){this._elements.arrival.address.onSelect(address=>{this.data.addresses.arrival.value=address.formatted_address,this.data.addresses.arrival.components.streetNumber=this._getAddressComponent(address,"street_number"),this.data.addresses.arrival.components.route=this._getAddressComponent(address,"route"),this.data.addresses.arrival.components.zipCode=this._getAddressComponent(address,"postal_code"),this.data.addresses.arrival.components.locality=this._getAddressComponent(address,"locality"),this.data.addresses.arrival.components.country=this._getAddressComponent(address,"country"),this.data.addresses.arrival.components.countryCode=this._getAddressComponent(address,"country",!0),this.data.addresses.arrival.components.department=this._getAddressComponent(address,"administrative_area_level_2"),this.data.addresses.arrival.components.region=this._getAddressComponent(address,"administrative_area_level_1"),this.data.addresses.arrival.location.lat=address.geometry.location.lat(),this.data.addresses.arrival.location.lng=address.geometry.location.lng(),this.data.addresses.arrival.location.placeId=address.place_id,this._elements.departure.address.value.formatted_address&&this._elements.arrival.address.value.formatted_address?this._elements.validation.addresses.disabled=!1:this._elements.validation.addresses.disabled=!0}),Object.values(this._parameters.options).some(option=>1==option)&&(this._elements.arrival.optionToggler.addEventListener("click",e=>{e.preventDefault(),this._elements.arrival.optionToggler.classList.contains("mcc-address-options-enable")?(this._elements.arrival.optionToggler.classList.remove("mcc-address-options-enable"),this._elements.arrival.optionToggler.classList.add("mcc-address-options-disable"),this._elements.arrival.optionToggler.innerText=this._translated().lessAddressOptions,this._elements.wrapper.querySelector(".mcc-arrival.mcc-address-options").classList.remove("mcc-hidden")):(this._elements.arrival.optionToggler.classList.remove("mcc-address-options-disable"),this._elements.arrival.optionToggler.classList.add("mcc-address-options-enable"),this._elements.arrival.optionToggler.innerText=this._translated().moreAddressOptions,this._elements.wrapper.querySelector(".mcc-arrival.mcc-address-options").classList.add("mcc-hidden"))}),this._parameters.options.floor&&this._elements.arrival.options.floor.addEventListener("change",()=>{this.data.addresses.arrival.options.floor=+this._elements.arrival.options.floor.value}),this._parameters.options.lift&&this._elements.arrival.options.lift.addEventListener("change",()=>{this.data.addresses.arrival.options.lift="true"==this._elements.arrival.options.lift.value}),this._parameters.options.porterageDistance&&this._elements.arrival.options.porterageDistance.addEventListener("change",()=>{this.data.addresses.arrival.options.porterageDistance=+this._elements.arrival.options.porterageDistance.value}))}_translated(){return this._dictionary[this._parameters.lang]}_getAddressComponent(address,component,isShort){const target=address.address_components.find(c=>c.types.includes(component));return target?isShort?target.short_name:target.long_name:""}setLang(lang){return this._parameters.lang=lang||"en",this}validate(){return this._parameters.remoteCalculator?new AjaxSender(this._parameters.remoteCalculator,{data:this.data,method:"POST",load:response=>{console.log(response),this._elements.wrapper.querySelector("section.mcc-estimations").innerHTML=`\n\t\t\t\t\t\t<div style="font-family: 'Courier New', Courier, monospace">${response[0].logs.map(log=>`${log}<br />`).join("")}</div>\n\t\t\t\t\t`,this._elements.wrapper.querySelector("section.mcc-estimations").innerHTML+=`\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t${response.map(offer=>`\n\t\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t\t<p>${offer.name}</p>\n\t\t\t\t\t\t\t\t\t<p>(Admin) Prix: ${offer.price} €</p>\n\t\t\t\t\t\t\t\t\t<p>De: ${offer.price-offer.range} €</p>\n\t\t\t\t\t\t\t\t\t<p>A: ${offer.price+offer.range} €</p>\n\t\t\t\t\t\t\t\t\t<p>Services:</p>\n\t\t\t\t\t\t\t\t\t${offer.services.map(service=>`\n\t\t\t\t\t\t\t\t\t\t<p>${service}</p>\n\t\t\t\t\t\t\t\t\t`).join("")}\n\t\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t`).join("")}\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t`,this._elements.wrapper.querySelector("section.mcc-loader").classList.add("mcc-hidden"),this._elements.wrapper.querySelector("section.mcc-estimations").classList.remove("mcc-hidden")},error:error=>{console.log(error)}}):(this._elements.wrapper.querySelector("section.mcc-loader").classList.add("mcc-hidden"),this._elements.wrapper.querySelector("section.mcc-estimations").classList.remove("mcc-hidden")),this}destroy(){this._elements.wrapper.innerHTML="",this._elements.wrapper.classList.remove("mcc-wrapper")}static destroy(selector){const element=document.querySelector(selector);element&&element.classList.contains("mcc-wrapper")&&(element.innerHTML="",element.classList.remove("mcc-wrapper"))}}